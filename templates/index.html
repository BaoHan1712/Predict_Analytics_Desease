<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªá th·ªëng H·ªó tr·ª£ Ch·∫©n ƒëo√°n B·ªánh Tim b·∫±ng AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; box-sizing: border-box; }
    .heart-beat { animation: heartbeat 1.5s ease-in-out infinite; }
    @keyframes heartbeat {
      0% { transform: scale(1); }
      14% { transform: scale(1.1); }
      28% { transform: scale(1); }
      42% { transform: scale(1.1); }
      70% { transform: scale(1); }
    }
    .medical-gradient { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    .result-card { transition: all 0.3s ease; transform: translateY(10px); opacity: 0; }
    .result-card.show { transform: translateY(0); opacity: 1; }
  </style>
</head>

<body class="bg-gray-50 min-h-full">
  <header class="medical-gradient text-white py-8 text-center">
    <div class="flex justify-center items-center mb-4">
      <div class="text-6xl mr-4">üè•</div>
      <div class="heart-beat text-4xl">‚ù§Ô∏è</div>
    </div>
    <h1 class="text-4xl font-bold mb-4">H·ªá th·ªëng H·ªó tr·ª£ Ch·∫©n ƒëo√°n B·ªánh Tim b·∫±ng Tr√≠ Tu·ªá Nh√¢n T·∫°o</h1>
    <p class="text-xl text-blue-100">·ª®ng d·ª•ng AI trong h·ªó tr·ª£ b√°c sƒ© ch·∫©n ƒëo√°n nguy c∆° b·ªánh tim d·ª±a tr√™n d·ªØ li·ªáu l√¢m s√†ng.</p>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Form -->
      <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-semibold mb-6 flex items-center"><span class="mr-3">üìã</span>Th√¥ng tin b·ªánh nh√¢n</h2>
        <form id="heartForm" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div><label>Tu·ªïi</label><input type="number" id="age" name="age" class="w-full p-3 border rounded-lg" required></div>
            <div><label>Gi·ªõi t√≠nh</label><select id="sex" name="sex" class="w-full p-3 border rounded-lg"><option value="1">Nam</option><option value="0">N·ªØ</option></select></div>
            <div><label>Lo·∫°i ƒëau ng·ª±c</label><select id="cp" name="cp" class="w-full p-3 border rounded-lg"><option value="0">Kh√¥ng</option><option value="1">ƒêi·ªÉn h√¨nh</option><option value="2">Kh√¥ng ƒëi·ªÉn h√¨nh</option><option value="3">Kh√¥ng do tim</option></select></div>
            <div><label>Huy·∫øt √°p</label><input type="number" id="trestbps" name="trestbps" class="w-full p-3 border rounded-lg" required></div>
            <div><label>Cholesterol</label><input type="number" id="chol" name="chol" class="w-full p-3 border rounded-lg" required></div>
            <div><label>ƒê∆∞·ªùng huy·∫øt</label><select id="fbs" name="fbs" class="w-full p-3 border rounded-lg"><option value="1">Cao</option><option value="0">B√¨nh th∆∞·ªùng</option></select></div>
            <div><label>ƒêi·ªán t√¢m ƒë·ªì</label><select id="restecg" name="restecg" class="w-full p-3 border rounded-lg"><option value="0">B√¨nh th∆∞·ªùng</option><option value="1">ST-T b·∫•t th∆∞·ªùng</option><option value="2">Ph√¨ ƒë·∫°i th·∫•t tr√°i</option></select></div>
            <div><label>Nh·ªãp tim t·ªëi ƒëa</label><input type="number" id="thalach" name="thalach" class="w-full p-3 border rounded-lg" required></div>
            <div><label>ƒêau khi v·∫≠n ƒë·ªông</label><select id="exang" name="exang" class="w-full p-3 border rounded-lg"><option value="1">C√≥</option><option value="0">Kh√¥ng</option></select></div>
            <div><label>M·ª©c ST ch√™nh</label><input type="number" id="oldpeak" name="oldpeak" class="w-full p-3 border rounded-lg" step="0.1" required></div>
            <div><label>D·ªëc ST</label><select id="slope" name="slope" class="w-full p-3 border rounded-lg"><option value="0">Xu·ªëng</option><option value="1">Ph·∫≥ng</option><option value="2">L√™n</option></select></div>
            <div><label>M·∫°ch m√°u l·ªõn</label><select id="ca" name="ca" class="w-full p-3 border rounded-lg"><option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
            <div><label>Khi·∫øm khuy·∫øt m√°u (thal)</label><select id="thal" name="thal" class="w-full p-3 border rounded-lg"><option value="1">B√¨nh th∆∞·ªùng</option><option value="2">C·ªë ƒë·ªãnh</option><option value="3">Ph·ª•c h·ªìi</option></select></div>
          </div>

          <div class="text-center pt-6">
            <button type="submit" id="analyzeBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-lg flex justify-center items-center mx-auto">
              <span class="mr-2">ü©∫</span><span id="btnText">Ph√¢n t√≠ch AI</span>
              <div id="loadingSpinner" class="loading-spinner ml-3 hidden"></div>
            </button>
          </div>
        </form>
      </div>

      <!-- K·∫øt qu·∫£ -->
      <div class="lg:col-span-1 bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-semibold mb-4 flex items-center"><span class="mr-3">üî¨</span>K·∫øt qu·∫£ ph√¢n t√≠ch</h2>

        <div id="resultContainer" class="hidden result-card">
          <div id="resultCard" class="p-6 rounded-lg border-2 mb-6 text-center">
            <div class="text-4xl mb-4 heart-beat">‚ù§Ô∏è</div>
            <div id="resultText" class="text-xl font-semibold mb-4"></div>
            <div id="probabilityText" class="text-lg text-gray-600 mb-4"></div>
          </div>
          <div class="mb-6"><canvas id="probabilityChart" width="300" height="200"></canvas></div>

          <!-- Ph√¢n t√≠ch chi ti·∫øt -->
          <div id="analysisDetails" class="hidden text-left bg-blue-50 p-4 rounded-lg text-sm leading-relaxed">
            <p><strong>T√¨nh tr·∫°ng:</strong> <span id="tinhTrang">-</span></p>
            <p><strong>Nguy√™n nh√¢n:</strong> <span id="nguyenNhan">-</span></p>
            <p><strong>Ch·∫ø ƒë·ªô dinh d∆∞·ª°ng:</strong> <span id="cheDoDinhDuong">-</span></p>
            <p><strong>V·∫≠n ƒë·ªông:</strong> <span id="vanDong">-</span></p>
            <p><strong>Theo d√µi:</strong> <span id="theoDoi">-</span></p>
          </div>

          <button id="exportPdfBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg mt-4">
            üìÑ Xu·∫•t b√°o c√°o PDF
          </button>
        </div>

        <div id="placeholderText" class="text-center text-gray-500 py-12">
          <div class="text-6xl mb-4">üîç</div>
          <p>Nh·∫≠p th√¥ng tin v√† nh·∫•n ‚ÄúPh√¢n t√≠ch AI‚Äù ƒë·ªÉ xem k·∫øt qu·∫£</p>
        </div>
      </div>
    </div>
  </main>

  <script>
  let currentChart = null, currentResult = null;

  document.getElementById('heartForm').addEventListener('submit', async e => {
    e.preventDefault();

    const analyzeBtn = document.getElementById('analyzeBtn');
    const btnText = document.getElementById('btnText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    analyzeBtn.disabled = true;
    btnText.textContent = 'ƒêang ph√¢n t√≠ch...';
    loadingSpinner.classList.remove('hidden');

    const formData = new FormData(e.target);

    try {
      const response = await fetch("/predict", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: formData
      });
      const data = await response.json();
      console.log("üì© Response backend:", data);

      if (data.success) {
        displayResult(data.result.prediction, data.result.probability, data.analysis_text);
      } else {
        alert("‚ùå L·ªói: " + (data.error || "Kh√¥ng th·ªÉ ph√¢n t√≠ch"));
      }
    } catch (err) {
      console.error("L·ªói request:", err);
      alert("‚ö†Ô∏è K·∫øt n·ªëi t·ªõi m√°y ch·ªß th·∫•t b·∫°i!");
    } finally {
      analyzeBtn.disabled = false;
      btnText.textContent = 'Ph√¢n t√≠ch AI';
      loadingSpinner.classList.add('hidden');
    }
  });

  function displayResult(prediction, probability, analysisText) {
    const resultContainer = document.getElementById('resultContainer');
    const placeholderText = document.getElementById('placeholderText');
    const resultCard = document.getElementById('resultCard');
    const resultText = document.getElementById('resultText');
    const probabilityText = document.getElementById('probabilityText');
    const analysisDetails = document.getElementById('analysisDetails');

    placeholderText.classList.add('hidden');
    resultContainer.classList.remove('hidden');

    resultCard.className = prediction === 1
      ? 'p-6 rounded-lg border-2 mb-6 border-red-500 bg-red-50'
      : 'p-6 rounded-lg border-2 mb-6 border-green-500 bg-green-50';
    resultText.textContent = prediction === 1 ? '‚ö†Ô∏è C√≥ d·∫•u hi·ªáu b·ªánh tim' : '‚úÖ Kh√¥ng c√≥ d·∫•u hi·ªáu b·ªánh tim';
    probabilityText.textContent = `X√°c su·∫•t: ${(probability * 100).toFixed(1)}%`;

    // Parse Gemini AI analysis JSON
    try {
      const analysis = JSON.parse(analysisText);
      document.getElementById('tinhTrang').textContent = analysis.tinh_trang || "-";
      document.getElementById('nguyenNhan').textContent = analysis.nguyen_nhan || "-";
      document.getElementById('cheDoDinhDuong').textContent = analysis.che_do_dinh_duong || "-";
      document.getElementById('vanDong').textContent = analysis.van_dong || "-";
      document.getElementById('theoDoi').textContent = analysis.theo_doi || "-";
      analysisDetails.classList.remove('hidden');
    } catch {
      console.warn("Ph√¢n t√≠ch AI kh√¥ng h·ª£p l·ªá:", analysisText);
    }

    setTimeout(() => resultContainer.classList.add('show'), 100);
    createChart(probability);
  }

  function createChart(probability) {
    const ctx = document.getElementById('probabilityChart').getContext('2d');
    if (currentChart) currentChart.destroy();
    const risk = probability * 100, safe = 100 - risk;
    currentChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Nguy c∆°', 'An to√†n'],
        datasets: [{ data: [risk, safe], backgroundColor: ['#ef4444', '#10b981'] }]
      },
      options: { plugins: { legend: { position: 'bottom' } } }
    });
  }

  document.getElementById('exportPdfBtn').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(14);
    doc.text("B√ÅO C√ÅO PH√ÇN T√çCH B·ªÜNH TIM", 20, 20);
    doc.text(`K·∫øt qu·∫£: ${document.getElementById('resultText').textContent}`, 20, 35);
    doc.text(`X√°c su·∫•t: ${document.getElementById('probabilityText').textContent}`, 20, 45);
    doc.text("Ph√¢n t√≠ch AI:", 20, 60);
    doc.text(`- T√¨nh tr·∫°ng: ${document.getElementById('tinhTrang').textContent}`, 20, 70);
    doc.text(`- Nguy√™n nh√¢n: ${document.getElementById('nguyenNhan').textContent}`, 20, 80);
    doc.text(`- Dinh d∆∞·ª°ng: ${document.getElementById('cheDoDinhDuong').textContent}`, 20, 90);
    doc.text(`- V·∫≠n ƒë·ªông: ${document.getElementById('vanDong').textContent}`, 20, 100);
    doc.text(`- Theo d√µi: ${document.getElementById('theoDoi').textContent}`, 20, 110);
    doc.save("bao_cao_AI_heart.pdf");
  });
  </script>
</body>
</html>
